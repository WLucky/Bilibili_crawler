# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: 下载B站评论

on:
  workflow_dispatch:
    inputs:
      bv_ids:
        description: '请填写BV号，多个用英文逗号分开'
        required: true
        default: 'BV1GDCFBhEAq,BV1sNy8BqEx3'
      bv_type:
        description: '请选择评论类型'
        required: true
        default: '视频评论'
        type: choice
        options:
          - 视频评论
          - 图文动态评论
          - 转发/文字动态评论

permissions:
  contents: write

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    - name: Clean Workspace
      run: |
        # 先检查当前目录结构
        pwd
        ls -la
        
        # 检查 comments 目录是否存在
        if [ -d "./comments" ]; then
          echo "Cleaning comments directory..."
          rm -rf ./comments/*.csv
          ls ./comments
        else
          echo "Comments directory not found, checking relative paths..."
          # 尝试其他可能的路径
          ls -la ./
          find . -name "comments" -type d
        fi
    - name: Run Python
      run: |
        # 获取用户选择的文字类型
        SELECTED_TYPE="${{ github.event.inputs.bv_type }}"
        
        # 文字到数字的映射
        case "$SELECTED_TYPE" in
          "视频评论")
            BV_TYPE="1"
            TYPE_DESC="视频评论"
            ;;
          "图文动态评论")
            BV_TYPE="11"
            TYPE_DESC="图文动态评论"
            ;;
          "转发/文字动态评论")
            BV_TYPE="17"
            TYPE_DESC="转发/文字动态评论"
            ;;
          *)
            echo "错误: 未知的评论类型: $SELECTED_TYPE"
            exit 1
            ;;
        esac
        
        IFS=',' read -ra BV_ARRAY <<< "${{ github.event.inputs.bv_ids }}"        
        for i in "${!BV_ARRAY[@]}"; do
          bv_id="${BV_ARRAY[$i]// /}"  # 去除空格
          echo "处理第 $((i+1)) 个视频: $bv_id 类型: $BV_TYPE" 
          
          python simple_bili_crawler.py "$bv_id" "$BV_TYPE"
          
          # 如果不是最后一个，休眠2分钟
          if [ $i -lt $((${#BV_ARRAY[@]} - 1)) ]; then
            echo "等待2分钟..."
            sleep 120
          fi
        done
    - name: List generated files (debug step)
      run: |
        echo "Preparing docker images list (.tar.gz) files:"
        ls -la comments/
        release_name="$(TZ="Asia/Shanghai" date +'%Y-%m-%d %H:%M Build')"
        echo "RELEASE_NAME=$release_name" >> $GITHUB_ENV

    - name: Create GitHub Release
      uses: softprops/action-gh-release@master
      with:
        tag_name: Comments-${{ github.run_id }}  # 使用唯一的run_id
        name: ${{ env.RELEASE_NAME }}
        body: |
          ### 数据见下方附件  
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload comments files as release assets
      uses: softprops/action-gh-release@v2.1.0
      with:
        tag_name: Comments-${{ github.run_id }}  # 使用唯一的run_id
        files: ${{ github.workspace }}/comments/*.csv
        token: ${{ secrets.GITHUB_TOKEN }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
